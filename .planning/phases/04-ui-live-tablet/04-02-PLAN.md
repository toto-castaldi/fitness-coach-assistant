---
phase: 04-ui-live-tablet
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/shared/hooks/useLiveCoaching.ts
  - src/shared/types/index.ts
  - src/live/pages/TabletLive.tsx
autonomous: true

must_haves:
  truths:
    - "Hook provides completeGroupExercise function that calls RPC"
    - "Hook provides skipGroupExerciseForClient function that calls RPC"
    - "Realtime subscription updates sessions state when session_exercises change"
    - "TabletLive has viewMode state toggling between 'individual' and 'group'"
  artifacts:
    - path: "src/shared/hooks/useLiveCoaching.ts"
      provides: "Group exercise functions and realtime subscription"
      exports: ["completeGroupExercise", "skipGroupExerciseForClient"]
    - path: "src/live/pages/TabletLive.tsx"
      provides: "View mode toggle UI"
      contains: "viewMode"
  key_links:
    - from: "useLiveCoaching.ts"
      to: "complete_group_exercise RPC"
      via: "supabase.rpc call"
      pattern: "supabase.rpc.*complete_group_exercise"
    - from: "useLiveCoaching.ts"
      to: "session_exercises realtime"
      via: "postgres_changes subscription"
      pattern: "postgres_changes.*session_exercises"
---

<objective>
Extend useLiveCoaching hook with group exercise functions and realtime subscription, add view mode toggle to TabletLive.

Purpose: The hook needs to expose RPC-based group operations and subscribe to realtime updates. TabletLive needs a toggle to switch between individual and group views.

Output: Extended hook with group functions and realtime, TabletLive with view toggle.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ui-live-tablet/04-RESEARCH.md
@.planning/phases/04-ui-live-tablet/04-01-PLAN.md

# Source files to modify
@src/shared/hooks/useLiveCoaching.ts
@src/live/pages/TabletLive.tsx
@src/shared/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useLiveCoaching with group functions and realtime</name>
  <files>src/shared/hooks/useLiveCoaching.ts, src/shared/types/index.ts</files>
  <action>
Add to useLiveCoaching.ts:

1. **Add currentDate state** to track the date for realtime subscription:
   - useState for currentDate (set in fetchSessionsForDate)

2. **Add completeGroupExercise function:**
   - Signature: `async (sessionDate: string, exerciseId: string): Promise<string[]>`
   - Optimistic update: Find all sessions, for each session's exercises where exercise_id matches and is_group=true and !completed, set completed=true, skipped=false, completed_at=now
   - Call supabase.rpc('complete_group_exercise', { p_session_date: sessionDate, p_exercise_id: exerciseId })
   - On error, call fetchSessionsForDate to rollback (refetch authoritative state)
   - Return array of updated IDs (from RPC result) or empty array on error
   - Use withSaveTracking wrapper like other functions

3. **Add skipGroupExerciseForClient function:**
   - Signature: `async (sessionExerciseId: string): Promise<boolean>`
   - Optimistic update: Find the exercise by ID, set skipped=true, completed=false, completed_at=null
   - Call supabase.rpc('skip_group_exercise_for_client', { p_session_exercise_id: sessionExerciseId })
   - On error, refetch
   - Use withSaveTracking wrapper

4. **Add realtime subscription in useEffect:**
   - Dependency: currentDate
   - Create channel `session_exercises_${currentDate}`
   - Subscribe to postgres_changes event 'UPDATE' on schema 'public', table 'session_exercises'
   - On payload, update sessions state: map over sessions, map over exercises, if ex.id matches updated.id, merge completed, skipped, completed_at from payload.new
   - Cleanup: supabase.removeChannel(channel)
   - Follow pattern from 04-RESEARCH.md

5. **Export new functions** in return statement.

Add to types/index.ts if needed:
- Ensure SessionExercise has is_group?: boolean (already added in phase 1)
  </action>
  <verify>
`npm run build` succeeds.
TypeScript compiles without errors.
New functions are exported from hook.
  </verify>
  <done>
useLiveCoaching exports completeGroupExercise, skipGroupExerciseForClient.
Realtime subscription updates sessions on session_exercises changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add view mode toggle to TabletLive</name>
  <files>src/live/pages/TabletLive.tsx</files>
  <action>
Modify TabletLive.tsx:

1. **Add viewMode state:**
   ```typescript
   const [viewMode, setViewMode] = useState<'individual' | 'group'>('individual')
   ```

2. **Add toggle UI in header** (after ClientStripBar, before SaveIndicator):
   ```typescript
   import { Users } from 'lucide-react'
   import { cn } from '@/shared/lib/utils'

   // In header, after ClientStripBar:
   <div className="flex gap-2 mx-4">
     <Button
       onClick={() => setViewMode('individual')}
       size="sm"
       className={cn(
         'px-3 py-1',
         viewMode === 'individual'
           ? 'bg-primary text-white'
           : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
       )}
     >
       Individuali
     </Button>
     <Button
       onClick={() => setViewMode('group')}
       size="sm"
       className={cn(
         'px-3 py-1',
         viewMode === 'group'
           ? 'bg-primary text-white'
           : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
       )}
     >
       <Users className="w-4 h-4 mr-1" />
       Gruppo
     </Button>
   </div>
   ```

3. **Destructure new functions from hook:**
   Add completeGroupExercise, skipGroupExerciseForClient to the useLiveCoaching destructure.

4. **Add conditional rendering placeholder** in main content:
   ```typescript
   {viewMode === 'individual' ? (
     // Existing ActionPanel + ExerciseCarousel
   ) : (
     // Placeholder for group view (will be implemented in plan 03)
     <div className="flex-1 flex items-center justify-center text-gray-400">
       Vista gruppo - coming in next plan
     </div>
   )}
   ```

The actual GroupExerciseView component will be created in Plan 03.
  </action>
  <verify>
`npm run build` succeeds.
Dev server: Toggle buttons appear in header.
Clicking toggles switches viewMode (individual view shows carousel, group shows placeholder).
  </verify>
  <done>
TabletLive has view mode toggle.
Individual mode shows existing carousel.
Group mode shows placeholder (to be replaced in plan 03).
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run build` succeeds
- [ ] useLiveCoaching exports completeGroupExercise, skipGroupExerciseForClient
- [ ] TabletLive has Individuali/Gruppo toggle buttons in header
- [ ] Toggle switches between individual carousel and group placeholder
</verification>

<success_criteria>
- Hook extended with group RPC functions and realtime subscription
- TabletLive has working view mode toggle
- Individual mode unchanged, group mode shows placeholder
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-live-tablet/04-02-SUMMARY.md`
</output>
