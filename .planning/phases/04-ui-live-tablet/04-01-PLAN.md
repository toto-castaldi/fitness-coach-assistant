---
phase: 04-ui-live-tablet
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000018_group_rpc.sql
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "RPC complete_group_exercise updates all matching session_exercises atomically"
    - "RPC skip_group_exercise_for_client marks single exercise as skipped"
    - "Realtime subscription receives updates when session_exercises change"
  artifacts:
    - path: "supabase/migrations/00000000000018_group_rpc.sql"
      provides: "RPC functions and realtime publication"
      contains: "complete_group_exercise"
    - path: "CLAUDE.md"
      provides: "Documentation of new RPC functions"
  key_links:
    - from: "complete_group_exercise"
      to: "session_exercises + sessions"
      via: "JOIN on session_id and session_date filter"
      pattern: "WHERE se.session_id = s.id AND s.session_date"
---

<objective>
Create PostgreSQL RPC functions for atomic group exercise updates and enable realtime on session_exercises.

Purpose: The tablet live UI needs to complete all participants' exercises atomically (complete_group_exercise) and allow individual skips (skip_group_exercise_for_client). Realtime enables cross-tablet sync.

Output: Migration file with RPC functions and realtime publication.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ui-live-tablet/04-RESEARCH.md

# Prior phase - database schema already has is_group column
@.planning/phases/01-database-schema/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RPC functions migration</name>
  <files>supabase/migrations/00000000000018_group_rpc.sql</files>
  <action>
Create migration with:

1. **complete_group_exercise(p_session_date DATE, p_exercise_id UUID)** - Returns TABLE(updated_id UUID)
   - Use SECURITY INVOKER (respects RLS)
   - JOIN session_exercises with sessions on session_id
   - Filter: s.session_date = p_session_date, se.exercise_id = p_exercise_id, se.is_group = true, se.completed = false
   - UPDATE: completed = true, completed_at = NOW(), skipped = false
   - RETURN QUERY with RETURNING se.id

2. **skip_group_exercise_for_client(p_session_exercise_id UUID)** - Returns boolean
   - Use SECURITY INVOKER
   - UPDATE session_exercises WHERE id = p_session_exercise_id AND is_group = true
   - SET skipped = true, completed = false, completed_at = NULL
   - RETURN FOUND

3. **Enable realtime on session_exercises:**
   - ALTER PUBLICATION supabase_realtime ADD TABLE session_exercises;
   - ALTER TABLE session_exercises REPLICA IDENTITY FULL;

4. **Grant permissions:**
   - GRANT EXECUTE ON FUNCTION complete_group_exercise TO authenticated;
   - GRANT EXECUTE ON FUNCTION skip_group_exercise_for_client TO authenticated;

Follow exact patterns from 04-RESEARCH.md code examples.
  </action>
  <verify>
Local Supabase: `npm run supabase:reset` succeeds and functions are created.
Test RPC exists: Run `supabase db reset` and verify no errors.
  </verify>
  <done>
Migration 00000000000018 exists with both RPC functions and realtime enabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLAUDE.md documentation</name>
  <files>CLAUDE.md</files>
  <action>
Add to Database section after tables, before "All tables have Row Level Security":

```
**RPC Functions:**

| Function | Description |
|----------|-------------|
| `complete_group_exercise(p_session_date, p_exercise_id)` | Marks all group exercises matching date+exercise as completed atomically |
| `skip_group_exercise_for_client(p_session_exercise_id)` | Marks single group exercise as skipped for one client |
```

Also add note about realtime: "Note: `session_exercises` table has realtime enabled for cross-tablet sync."
  </action>
  <verify>`grep "complete_group_exercise" CLAUDE.md` returns the function documentation.</verify>
  <done>CLAUDE.md documents both RPC functions and realtime note.</done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/00000000000018_group_rpc.sql
- [ ] `npm run supabase:reset` succeeds without errors
- [ ] CLAUDE.md updated with RPC function documentation
- [ ] `npm run build` still succeeds (no TypeScript changes in this plan)
</verification>

<success_criteria>
- RPC functions complete_group_exercise and skip_group_exercise_for_client created
- Realtime publication includes session_exercises with REPLICA IDENTITY FULL
- Documentation updated
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-live-tablet/04-01-SUMMARY.md`
</output>
