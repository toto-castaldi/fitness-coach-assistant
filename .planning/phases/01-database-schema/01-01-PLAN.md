---
phase: 01-database-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000017_add_is_group.sql
  - src/shared/types/index.ts
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "Existing session_exercises rows have is_group = false"
    - "New session_exercises rows can have is_group = true"
    - "Existing queries continue to work unchanged"
    - "RLS policies protect is_group like other columns"
  artifacts:
    - path: "supabase/migrations/00000000000017_add_is_group.sql"
      provides: "Migration adding is_group column"
      contains: "ADD COLUMN is_group BOOLEAN NOT NULL DEFAULT false"
    - path: "src/shared/types/index.ts"
      provides: "TypeScript types with is_group field"
      contains: "is_group: boolean"
  key_links:
    - from: "SessionExercise interface"
      to: "session_exercises table"
      via: "Supabase client"
      pattern: "is_group.*boolean"
---

<objective>
Add `is_group` boolean column to session_exercises table with backward-compatible defaults.

Purpose: Enable Phase 2-4 features by providing the database foundation for group exercises. This is a purely additive schema change.

Output:
- Migration file that adds is_group column with partial index
- Updated TypeScript types reflecting the new field
- Updated CLAUDE.md documenting the schema change
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema/01-RESEARCH.md
@CLAUDE.md
@src/shared/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration file</name>
  <files>supabase/migrations/00000000000017_add_is_group.sql</files>
  <action>
Create migration file `00000000000017_add_is_group.sql` with:

```sql
-- Add is_group flag to session_exercises for group exercise support
-- Milestone: Esercizi di Gruppo - Phase 1

ALTER TABLE public.session_exercises
  ADD COLUMN is_group BOOLEAN NOT NULL DEFAULT false;

-- Partial index for efficient filtering of group exercises
-- Only indexes rows where is_group = true (smaller, faster)
CREATE INDEX session_exercises_is_group_idx
  ON public.session_exercises(is_group)
  WHERE is_group = true;
```

Follow existing migration naming convention (incrementing from 00000000000016).
Use NOT NULL DEFAULT false for backward compatibility - all existing rows automatically get false.
Use partial index (not full index) for space efficiency since most exercises will not be group exercises.
  </action>
  <verify>
Run local Supabase reset and verify:
```bash
npm run supabase:reset
```
Then verify column exists and has correct default:
```bash
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "\d public.session_exercises" | grep is_group
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "SELECT indexdef FROM pg_indexes WHERE indexname = 'session_exercises_is_group_idx';"
```
  </verify>
  <done>
- Column `is_group` exists with type `boolean`, NOT NULL, DEFAULT false
- Partial index `session_exercises_is_group_idx` exists with WHERE clause
- Migration runs without error on fresh database
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types</name>
  <files>src/shared/types/index.ts</files>
  <action>
Update the SessionExercise-related interfaces in `src/shared/types/index.ts`:

1. Add `is_group: boolean` to `SessionExercise` interface (after `skipped` field)
2. Add `is_group?: boolean` to `SessionExerciseInsert` interface (optional, defaults to false in DB)
3. Add `is_group?: boolean` to `SessionExerciseUpdate` interface

The types must match the database schema exactly. is_group is required in the main interface (always returned by DB) but optional in Insert/Update (has DB default).
  </action>
  <verify>
```bash
cd /home/toto/scm-projects/helix && npm run build 2>&1 | head -50
```
Build should succeed without type errors.
  </verify>
  <done>
- SessionExercise interface has `is_group: boolean`
- SessionExerciseInsert interface has `is_group?: boolean`
- SessionExerciseUpdate interface has `is_group?: boolean`
- Project builds without type errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CLAUDE.md documentation</name>
  <files>CLAUDE.md</files>
  <action>
Update CLAUDE.md Database section to document the new column:

In the `session_exercises` table description, add the `is_group` field:
- `session_exercises` - Exercises in a session (exercise_id, order_index, sets, reps, weight_kg, duration_seconds, completed, completed_at, **is_group**)

This follows the project rule: "Update CLAUDE.md after migrations."
  </action>
  <verify>
```bash
grep "is_group" /home/toto/scm-projects/helix/CLAUDE.md
```
Should show is_group mentioned in session_exercises description.
  </verify>
  <done>
- CLAUDE.md Database section updated with is_group field
- Description matches actual schema
  </done>
</task>

</tasks>

<verification>
After all tasks complete, run full verification:

1. **Migration verification:**
```bash
npm run supabase:reset
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "SELECT column_name, data_type, is_nullable, column_default FROM information_schema.columns WHERE table_name = 'session_exercises' AND column_name = 'is_group';"
```
Expected: `is_group | boolean | NO | false`

2. **Existing data verification:**
```bash
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "SELECT COUNT(*) as total, COUNT(*) FILTER (WHERE is_group = false) as with_false FROM public.session_exercises;"
```
Expected: total = with_false (all existing rows have default false)

3. **Insert with is_group=true verification:**
```bash
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "
INSERT INTO public.session_exercises (session_id, exercise_id, order_index, is_group)
SELECT id, (SELECT id FROM public.exercises LIMIT 1), 999, true
FROM public.sessions LIMIT 1
RETURNING is_group;"
```
Expected: Returns `true`

4. **Build verification:**
```bash
npm run build
```
Expected: No errors

5. **Index verification:**
```bash
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "SELECT indexdef FROM pg_indexes WHERE indexname = 'session_exercises_is_group_idx';"
```
Expected: Shows partial index with `WHERE (is_group = true)`
</verification>

<success_criteria>
- [ ] Migration file exists at correct path
- [ ] Migration runs without error
- [ ] Column is_group exists with correct type (boolean), NOT NULL, DEFAULT false
- [ ] Partial index exists for is_group = true
- [ ] All existing session_exercises rows have is_group = false
- [ ] TypeScript types updated (SessionExercise, SessionExerciseInsert, SessionExerciseUpdate)
- [ ] Project builds without type errors
- [ ] CLAUDE.md Database section updated
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-schema/01-01-SUMMARY.md`
</output>
